<div class="flex flex-col flex-1 overflow-hidden p-4" style="height: calc(100vh - 48px)">
	<!-- Header -->
	<div class="flex justify-between items-center mb-4">
		<div class="flex items-baseline gap-3">
			<h2 class="text-xl font-semibold">Art Studio</h2>
		</div>
		<button class="btn btn-sm btn-primary" (click)="loadCharts()" [disabled]="loadingCharts()">
			<i class="bi bi-arrow-clockwise" [class.animate-spin]="loadingCharts()"></i>
			Refresh
		</button>
	</div>

	<!-- Overview Mode -->
	@if (viewMode() === 'overview') {
		<div class="flex-1 overflow-y-auto scrollbar scrollbar-w-2 scrollbar-track-base-300 scrollbar-thumb-neutral scrollbar-thumb-rounded-full">
			<div class="grid grid-cols-4 gap-4">
				<!-- Album Art Card -->
				<div class="card bg-base-200 shadow-lg cursor-pointer hover:bg-base-300 transition-colors" (click)="setViewMode('albumArt')">
					<div class="card-body">
						<div class="flex items-center gap-4">
							<div class="text-4xl text-primary">
								<i class="bi bi-image"></i>
							</div>
							<div>
								<h3 class="card-title">Album Art</h3>
								<p class="text-base-content/60 text-sm">Fetch missing</p>
							</div>
						</div>
						<div class="divider my-2"></div>
						<div class="stats bg-base-100">
							<div class="stat py-2">
								<div class="stat-value text-warning">{{ chartsMissingAlbumArt().length }}</div>
								<div class="stat-title text-xs">Missing art</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Backgrounds Card -->
				<div class="card bg-base-200 shadow-lg cursor-pointer hover:bg-base-300 transition-colors" (click)="setViewMode('backgrounds')">
					<div class="card-body">
						<div class="flex items-center gap-4">
							<div class="text-4xl text-secondary">
								<i class="bi bi-file-image"></i>
							</div>
							<div>
								<h3 class="card-title">Backgrounds</h3>
								<p class="text-base-content/60 text-sm">Generate missing</p>
							</div>
						</div>
						<div class="divider my-2"></div>
						<div class="stats bg-base-100">
							<div class="stat py-2">
								<div class="stat-value text-warning">{{ chartsMissingBackground().length }}</div>
								<div class="stat-title text-xs">Missing BG</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Browse All Art Card -->
				<div class="card bg-base-200 shadow-lg cursor-pointer hover:bg-base-300 transition-colors" (click)="setViewMode('browseAll')">
					<div class="card-body">
						<div class="flex items-center gap-4">
							<div class="text-4xl text-accent">
								<i class="bi bi-grid-3x3-gap"></i>
							</div>
							<div>
								<h3 class="card-title">Browse Art</h3>
								<p class="text-base-content/60 text-sm">View & replace</p>
							</div>
						</div>
						<div class="divider my-2"></div>
						<div class="stats bg-base-100">
							<div class="stat py-2">
								<div class="stat-value text-info">{{ catalogService.charts().length }}</div>
								<div class="stat-title text-xs">Total charts</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Browse All Backgrounds Card -->
				<div class="card bg-base-200 shadow-lg cursor-pointer hover:bg-base-300 transition-colors" (click)="setViewMode('browseBackgrounds')">
					<div class="card-body">
						<div class="flex items-center gap-4">
							<div class="text-4xl text-info">
								<i class="bi bi-grid-3x3"></i>
							</div>
							<div>
								<h3 class="card-title">Browse BG</h3>
								<p class="text-base-content/60 text-sm">View & regenerate</p>
							</div>
						</div>
						<div class="divider my-2"></div>
						<div class="stats bg-base-100">
							<div class="stat py-2">
								<div class="stat-value text-info">{{ catalogService.charts().length }}</div>
								<div class="stat-title text-xs">Total charts</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Quick Stats -->
			<div class="mt-6">
				<h3 class="text-lg font-semibold mb-3">Quick Actions</h3>
				<div class="flex gap-3">
					<button class="btn btn-outline" (click)="setViewMode('albumArt')" [disabled]="chartsMissingAlbumArt().length === 0">
						<i class="bi bi-download"></i>
						Fetch All Album Art
					</button>
					<button class="btn btn-outline" (click)="setViewMode('backgrounds')" [disabled]="chartsMissingBackground().length === 0">
						<i class="bi bi-magic"></i>
						Generate All Backgrounds
					</button>
				</div>
			</div>
		</div>
	}

	<!-- Album Art Mode -->
	@if (viewMode() === 'albumArt') {
		<div class="flex-1 min-h-0 flex flex-col">
			<!-- Back and batch controls -->
			<div class="flex items-center gap-4 mb-4">
				<button class="btn btn-sm btn-ghost" (click)="setViewMode('overview')"><i class="bi bi-arrow-left"></i> Back</button>
				<h3 class="font-semibold flex-1">Album Art - {{ filteredAlbumArtCharts().length }} of {{ chartsMissingAlbumArt().length }} charts</h3>
				<button class="btn btn-sm" [class.btn-primary]="batchMode()" [class.btn-ghost]="!batchMode()" (click)="toggleBatchMode()">
					<i class="bi bi-check2-square"></i>
					{{ batchMode() ? 'Cancel Batch' : 'Batch Mode' }}
				</button>
			</div>
			<!-- Search and Filter Bar -->
			@if (chartsMissingAlbumArt().length > 0 && !selectedChart()) {
				<div class="flex gap-2 mb-3 items-center flex-wrap">
					<div class="join">
						<input
							type="text"
							placeholder="Search artist or song..."
							class="input input-sm input-bordered join-item w-48"
							[ngModel]="filterQuery()"
							(ngModelChange)="onFilterQueryChange($event); applyAlbumArtFilter()" />
						@if (filterQuery()) {
							<button class="btn btn-sm btn-ghost join-item" (click)="onFilterQueryChange(''); applyAlbumArtFilter()">
								<i class="bi bi-x"></i>
							</button>
						}
					</div>
					<select class="select select-sm select-bordered w-40" [ngModel]="filterArtist()" (ngModelChange)="onFilterArtistChange($event); applyAlbumArtFilter()">
						<option value="">All Artists</option>
						@for (artist of albumArtArtistOptions(); track artist) {
							<option [value]="artist">{{ artist }}</option>
						}
					</select>
					<select class="select select-sm select-bordered w-32" [ngModel]="sortField()" (ngModelChange)="onSortFieldChange($event); applyAlbumArtFilter()">
						<option value="artist">Sort: Artist</option>
						<option value="name">Sort: Song</option>
					</select>
					<button class="btn btn-sm btn-ghost" (click)="toggleSortDirection()">
						<i class="bi" [class.bi-sort-alpha-down]="sortDirection() === 'asc'" [class.bi-sort-alpha-up]="sortDirection() === 'desc'"></i>
					</button>
					@if (filterQuery() || filterArtist()) {
						<button class="btn btn-sm btn-ghost" (click)="clearFilters()"><i class="bi bi-x-circle"></i> Clear</button>
					}
				</div>
			}
			<!-- Batch controls -->
			@if (batchMode() && !selectedChart()) {
				<div class="flex items-center gap-3 mb-4 p-3 bg-base-200 rounded-lg">
					<button class="btn btn-sm btn-ghost" (click)="selectAll(filteredAlbumArtCharts())">
						{{ selectedChartIds().size === filteredAlbumArtCharts().length ? 'Deselect All' : 'Select All' }}
					</button>
					<span class="text-sm text-base-content/60">{{ selectedChartIds().size }} selected</span>
					<div class="flex-1"></div>
					<button class="btn btn-sm btn-primary" (click)="batchFetchAlbumArt()" [disabled]="selectedChartIds().size === 0 || isProcessing()">
						<i class="bi bi-download"></i>
						Fetch Selected ({{ selectedChartIds().size }})
					</button>
				</div>
			}
			<!-- Batch results -->
			@if (batchResults()) {
				<div class="alert mb-4" [class.alert-success]="batchResults()!.failed === 0" [class.alert-warning]="batchResults()!.failed > 0">
					<i class="bi bi-info-circle"></i>
					<span> Completed: {{ batchResults()!.success }} success, {{ batchResults()!.failed }} failed, {{ batchResults()!.skipped }} skipped </span>
					<button class="btn btn-sm btn-ghost" (click)="clearBatchResults()">
						<i class="bi bi-x"></i>
					</button>
				</div>
			}
			<!-- Progress -->
			@if (downloadProgress() && isProcessing()) {
				<div class="mb-4">
					<div class="flex justify-between text-sm mb-1">
						<span>{{ downloadProgress()!.message }}</span>
						<span>{{ downloadProgress()!.percent }}%</span>
					</div>
					<progress class="progress progress-primary w-full" [value]="downloadProgress()!.percent" max="100"></progress>
				</div>
			}
			<!-- Chart list or detail view -->
			@if (!selectedChart()) {
				<div class="flex-1 overflow-y-auto scrollbar scrollbar-w-2 scrollbar-track-base-300 scrollbar-thumb-neutral scrollbar-thumb-rounded-full">
					<!-- No filter results -->
					@if (chartsMissingAlbumArt().length > 0 && filteredAlbumArtCharts().length === 0) {
						<div class="flex flex-col items-center justify-center h-full">
							<i class="bi bi-search text-4xl text-base-content/20 mb-4"></i>
							<h3 class="text-lg font-semibold mb-2">No Matches</h3>
							<p class="text-base-content/60 mb-4">No charts match your filter criteria.</p>
							<button class="btn btn-sm btn-ghost" (click)="clearFilters()">Clear Filters</button>
						</div>
					}
					<div class="space-y-2">
						@for (chart of filteredAlbumArtCharts(); track chart) {
							<div
								class="flex items-center gap-3 p-3 bg-base-200 rounded-lg hover:bg-base-300 cursor-pointer"
								(click)="!batchMode() && selectChart(chart)">
								@if (batchMode()) {
									<input
										type="checkbox"
										class="checkbox checkbox-sm"
										[checked]="selectedChartIds().has(chart.chartId)"
										(click)="$event.stopPropagation()"
										(change)="toggleChartSelection(chart.chartId)" />
								}
								<div class="flex-1 min-w-0">
									<div class="font-medium truncate">{{ chart.chartName }}</div>
									<div class="text-sm text-base-content/60 truncate">
										{{ chart.chartArtist }}
										@if (chart.chartAlbum) {
											<span>• {{ chart.chartAlbum }}</span>
										}
									</div>
								</div>
								@if (!batchMode()) {
									<button class="btn btn-sm btn-primary"><i class="bi bi-search"></i> Find Art</button>
								}
							</div>
						}
						@if (chartsMissingAlbumArt().length === 0) {
							<div class="text-center text-base-content/50 py-8">All charts have album art!</div>
						}
					</div>
				</div>
			}
			<!-- Selected chart - search results -->
			@if (selectedChart()) {
				<div class="flex-1 min-h-0 flex flex-col">
					<div class="flex items-center gap-4 mb-4">
						<button class="btn btn-sm btn-ghost" (click)="goBack()">
							<i class="bi bi-arrow-left"></i>
						</button>
						<div class="flex-1">
							<div class="font-medium">{{ selectedChart()!.chartName }}</div>
							<div class="text-sm text-base-content/60">{{ selectedChart()!.chartArtist }}</div>
						</div>
						<button class="btn btn-sm btn-ghost" (click)="searchAlbumArt()" [disabled]="isSearchingArt()">
							<i class="bi bi-arrow-clockwise" [class.animate-spin]="isSearchingArt()"></i>
							Retry Search
						</button>
					</div>
					@if (searchError()) {
						<div class="alert alert-error mb-4">
							<i class="bi bi-exclamation-circle"></i>
							<span>{{ searchError() }}</span>
						</div>
					}
					<div class="flex-1 overflow-y-auto scrollbar scrollbar-w-2 scrollbar-track-base-300 scrollbar-thumb-neutral scrollbar-thumb-rounded-full">
						<div class="grid grid-cols-4 gap-3">
							@for (result of albumArtResults(); track result) {
								<div class="card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" (click)="downloadAlbumArt(result)">
									<figure class="px-2 pt-2">
										<img [src]="result.url" class="rounded-lg w-full aspect-square object-cover" alt="Album art" loading="lazy" />
									</figure>
									<div class="card-body p-2">
										<div class="text-xs text-base-content/60 text-center">{{ result.source }} • {{ result.size }}</div>
									</div>
								</div>
							}
						</div>
						@if (isSearchingArt()) {
							<div class="flex items-center justify-center h-full">
								<span class="loading loading-spinner loading-lg"></span>
							</div>
						}
					</div>
				</div>
			}
		</div>
	}

	<!-- Backgrounds Mode -->
	@if (viewMode() === 'backgrounds') {
		<div class="flex-1 min-h-0 flex flex-col">
			<!-- Back and batch controls -->
			<div class="flex items-center gap-4 mb-4">
				<button class="btn btn-sm btn-ghost" (click)="setViewMode('overview')"><i class="bi bi-arrow-left"></i> Back</button>
				<h3 class="font-semibold flex-1">Backgrounds - {{ filteredBackgroundCharts().length }} of {{ chartsMissingBackground().length }} charts</h3>
				<button class="btn btn-sm" [class.btn-primary]="batchMode()" [class.btn-ghost]="!batchMode()" (click)="toggleBatchMode()">
					<i class="bi bi-check2-square"></i>
					{{ batchMode() ? 'Cancel Batch' : 'Batch Mode' }}
				</button>
			</div>
			<!-- Search and Filter Bar -->
			@if (chartsMissingBackground().length > 0) {
				<div class="flex gap-2 mb-3 items-center flex-wrap">
					<div class="join">
						<input
							type="text"
							placeholder="Search artist or song..."
							class="input input-sm input-bordered join-item w-48"
							[ngModel]="filterQuery()"
							(ngModelChange)="onFilterQueryChange($event); applyBackgroundFilter()" />
						@if (filterQuery()) {
							<button class="btn btn-sm btn-ghost join-item" (click)="onFilterQueryChange(''); applyBackgroundFilter()">
								<i class="bi bi-x"></i>
							</button>
						}
					</div>
					<select class="select select-sm select-bordered w-40" [ngModel]="filterArtist()" (ngModelChange)="onFilterArtistChange($event); applyBackgroundFilter()">
						<option value="">All Artists</option>
						@for (artist of backgroundArtistOptions(); track artist) {
							<option [value]="artist">{{ artist }}</option>
						}
					</select>
					<select class="select select-sm select-bordered w-32" [ngModel]="sortField()" (ngModelChange)="onSortFieldChange($event); applyBackgroundFilter()">
						<option value="artist">Sort: Artist</option>
						<option value="name">Sort: Song</option>
					</select>
					<button class="btn btn-sm btn-ghost" (click)="toggleSortDirection()">
						<i class="bi" [class.bi-sort-alpha-down]="sortDirection() === 'asc'" [class.bi-sort-alpha-up]="sortDirection() === 'desc'"></i>
					</button>
					@if (filterQuery() || filterArtist()) {
						<button class="btn btn-sm btn-ghost" (click)="clearFilters()"><i class="bi bi-x-circle"></i> Clear</button>
					}
					<!-- Blur control - always visible -->
					<div class="flex items-center gap-2 ml-auto pl-4 border-l border-base-300">
						<span class="text-sm">Blur:</span>
						<input type="range" min="0" max="50" [ngModel]="blurAmount()" (ngModelChange)="onBlurAmountChange($event)" class="range range-xs range-primary w-24" />
						<span class="text-sm font-mono w-6">{{ blurAmount() }}</span>
					</div>
				</div>
			}
			<!-- Batch controls -->
			@if (batchMode()) {
				<div class="flex flex-col gap-3 mb-4 p-3 bg-base-200 rounded-lg">
					<div class="flex items-center gap-3">
						<button class="btn btn-sm btn-ghost" (click)="selectAll(filteredBackgroundCharts())">
							{{ selectedChartIds().size === filteredBackgroundCharts().length ? 'Deselect All' : 'Select All' }}
						</button>
						<span class="text-sm text-base-content/60">{{ selectedChartIds().size }} selected</span>
						<div class="flex-1"></div>
						<button class="btn btn-sm btn-primary" (click)="batchGenerateBackgrounds()" [disabled]="selectedChartIds().size === 0 || isProcessing()">
							<i class="bi bi-magic"></i>
							Generate Selected
						</button>
					</div>
					<!-- Blur control and additional actions -->
					<div class="flex items-center gap-3 pt-2 border-t border-base-300">
						<div class="flex items-center gap-2">
							<span class="text-sm">Blur:</span>
							<input type="range" min="0" max="50" [ngModel]="blurAmount()" (ngModelChange)="onBlurAmountChange($event)" class="range range-xs range-primary w-32" />
							<span class="text-sm font-mono w-8">{{ blurAmount() }}</span>
						</div>
						<div class="flex-1"></div>
						<button
							class="btn btn-sm btn-warning"
							(click)="batchRegenerateBackgrounds()"
							[disabled]="selectedChartIds().size === 0 || isProcessing()"
							title="Delete and regenerate backgrounds with current blur setting">
							<i class="bi bi-arrow-repeat"></i>
							Regenerate
						</button>
						<button
							class="btn btn-sm btn-error"
							(click)="batchDeleteBackgrounds()"
							[disabled]="selectedChartIds().size === 0 || isProcessing()"
							title="Delete backgrounds from selected charts">
							<i class="bi bi-trash"></i>
							Delete
						</button>
					</div>
				</div>
			}
			<!-- Batch results -->
			@if (batchResults()) {
				<div class="alert mb-4" [class.alert-success]="batchResults()!.failed === 0" [class.alert-warning]="batchResults()!.failed > 0">
					<i class="bi bi-info-circle"></i>
					<span> Completed: {{ batchResults()!.success }} success, {{ batchResults()!.failed }} failed, {{ batchResults()!.skipped }} skipped </span>
					<button class="btn btn-sm btn-ghost" (click)="clearBatchResults()">
						<i class="bi bi-x"></i>
					</button>
				</div>
			}
			<!-- Progress -->
			@if (downloadProgress() && isProcessing()) {
				<div class="mb-4">
					<div class="flex justify-between text-sm mb-1">
						<span>{{ downloadProgress()!.message }}</span>
						<span>{{ downloadProgress()!.percent }}%</span>
					</div>
					<progress class="progress progress-secondary w-full" [value]="downloadProgress()!.percent" max="100"></progress>
				</div>
			}
			<!-- Chart list -->
			<div class="flex-1 overflow-y-auto scrollbar scrollbar-w-2 scrollbar-track-base-300 scrollbar-thumb-neutral scrollbar-thumb-rounded-full">
				<!-- No filter results -->
				@if (chartsMissingBackground().length > 0 && filteredBackgroundCharts().length === 0) {
					<div class="flex flex-col items-center justify-center h-full">
						<i class="bi bi-search text-4xl text-base-content/20 mb-4"></i>
						<h3 class="text-lg font-semibold mb-2">No Matches</h3>
						<p class="text-base-content/60 mb-4">No charts match your filter criteria.</p>
						<button class="btn btn-sm btn-ghost" (click)="clearFilters()">Clear Filters</button>
					</div>
				}
				<div class="space-y-2">
					@for (chart of filteredBackgroundCharts(); track chart) {
						<div class="flex items-center gap-3 p-3 bg-base-200 rounded-lg">
							@if (batchMode()) {
								<input
									type="checkbox"
									class="checkbox checkbox-sm"
									[checked]="selectedChartIds().has(chart.chartId)"
									(change)="toggleChartSelection(chart.chartId)" />
							}
							<div class="flex-1 min-w-0">
								<div class="font-medium truncate">{{ chart.chartName }}</div>
								<div class="text-sm text-base-content/60 truncate">
									{{ chart.chartArtist }}
									@if (chart.hasAlbumArt) {
										<span class="badge badge-sm badge-success ml-2">Has Art</span>
									}
									@if (!chart.hasAlbumArt) {
										<span class="badge badge-sm badge-ghost ml-2">No Art</span>
									}
								</div>
							</div>
							@if (!batchMode()) {
								<button class="btn btn-sm btn-secondary" (click)="selectedChart.set(chart); generateBackground()" [disabled]="isProcessing()">
									<i class="bi bi-magic"></i>
									{{ chart.hasAlbumArt ? 'Generate Blur' : 'Generate Gradient' }}
								</button>
							}
						</div>
					}
					@if (chartsMissingBackground().length === 0) {
						<div class="text-center text-base-content/50 py-8">All charts have backgrounds!</div>
					}
				</div>
			</div>
		</div>
	}

	<!-- Browse All Art Mode -->
	@if (viewMode() === 'browseAll') {
		<div class="flex-1 min-h-0 flex flex-col">
			<!-- Header -->
			<div class="flex items-center gap-4 mb-4">
				<button class="btn btn-sm btn-ghost" (click)="setViewMode('overview')"><i class="bi bi-arrow-left"></i> Back</button>
				<h3 class="font-semibold flex-1">Browse All Art - {{ filteredBrowseCharts().length }} charts</h3>
			</div>
			<!-- Filter Bar -->
			<div class="flex gap-2 mb-3 items-center flex-wrap">
				<div class="join">
					<input
						type="text"
						placeholder="Search artist or song..."
						class="input input-sm input-bordered join-item w-48"
						[ngModel]="filterQuery()"
						(ngModelChange)="onFilterQueryChange($event); applyBrowseFilter()" />
					@if (filterQuery()) {
						<button class="btn btn-sm btn-ghost join-item" (click)="onFilterQueryChange(''); applyBrowseFilter()">
							<i class="bi bi-x"></i>
						</button>
					}
				</div>
				<select class="select select-sm select-bordered w-40" [ngModel]="filterArtist()" (ngModelChange)="onFilterArtistChange($event); applyBrowseFilter()">
					<option value="">All Artists</option>
					@for (artist of browseArtistOptions(); track artist) {
						<option [value]="artist">{{ artist }}</option>
					}
				</select>
				<label class="cursor-pointer flex items-center gap-2">
					<input type="checkbox" class="checkbox checkbox-sm" [ngModel]="browseShowMissingOnly()" (ngModelChange)="onBrowseShowMissingOnlyChange($event)" />
					<span class="text-sm">Show missing only</span>
				</label>
			</div>
			<!-- Selected chart panel -->
			@if (selectedChart()) {
				<div class="mb-4 p-4 bg-base-200 rounded-lg">
					<div class="flex gap-4">
						<div class="w-32 h-32 bg-base-300 rounded flex items-center justify-center overflow-hidden">
							@if (selectedChart()!.hasAlbumArt && getAlbumArtUrl(selectedChart()!)) {
								<img [src]="getAlbumArtUrl(selectedChart()!)" class="w-full h-full object-cover" alt="Current album art" />
							}
							@if (selectedChart()!.hasAlbumArt && !getAlbumArtUrl(selectedChart()!)) {
								<span class="loading loading-spinner"></span>
							}
							@if (!selectedChart()!.hasAlbumArt) {
								<i class="bi bi-image text-4xl text-base-content/30"></i>
							}
						</div>
						<div class="flex-1">
							<h4 class="font-semibold">{{ selectedChart()!.chartName }}</h4>
							<p class="text-sm text-base-content/60">{{ selectedChart()!.chartArtist }}</p>
							<div class="mt-2 flex gap-2 flex-wrap">
								<button class="btn btn-sm btn-primary" (click)="searchAlbumArt()"><i class="bi bi-search"></i> Search iTunes</button>
								@if (selectedChart()!.hasAlbumArt) {
									<button class="btn btn-sm btn-secondary" (click)="regenerateSelectedBackground()"><i class="bi bi-magic"></i> Regenerate BG</button>
								}
								@if (selectedChart()!.hasAlbumArt) {
									<button class="btn btn-sm btn-error" (click)="deleteSelectedAlbumArt()"><i class="bi bi-trash"></i> Delete Art</button>
								}
								<button class="btn btn-sm btn-ghost" (click)="selectedChart.set(null)">Cancel</button>
							</div>
							<!-- Blur slider for background regeneration -->
							@if (selectedChart()!.hasAlbumArt) {
								<div class="mt-2 flex items-center gap-2">
									<span class="text-xs text-base-content/60">Blur:</span>
									<input type="range" min="0" max="50" [ngModel]="blurAmount()" (ngModelChange)="onBlurAmountChange($event)" class="range range-xs range-primary w-24" />
									<span class="text-xs font-mono">{{ blurAmount() }}</span>
								</div>
							}
						</div>
					</div>
					<!-- Album art search results -->
					@if (albumArtResults().length > 0 || isSearchingArt()) {
						<div class="mt-4">
							<div class="text-sm text-base-content/60 mb-2">Select new album art:</div>
							<div class="flex gap-2 flex-wrap">
								@if (isSearchingArt()) {
									<div class="w-24 h-24 bg-base-300 rounded flex items-center justify-center">
										<span class="loading loading-spinner"></span>
									</div>
								}
								@for (result of albumArtResults(); track result) {
									<div
										class="w-24 h-24 cursor-pointer rounded overflow-hidden border-2 border-transparent hover:border-primary"
										(click)="downloadAlbumArt(result)">
										<img [src]="result.url" class="w-full h-full object-cover" [alt]="result.source + ' - ' + result.size" />
									</div>
								}
							</div>
						</div>
					}
				</div>
			}
			<!-- Thumbnail Grid -->
			<div class="flex-1 overflow-y-auto scrollbar scrollbar-w-2 scrollbar-track-base-300 scrollbar-thumb-neutral scrollbar-thumb-rounded-full">
				<div class="grid gap-3" style="grid-template-columns: repeat(auto-fill, minmax(140px, 1fr))">
					@for (chart of filteredBrowseCharts(); track chart) {
						<div
							class="cursor-pointer rounded-lg overflow-hidden bg-base-200 hover:bg-base-300 transition-colors"
							[class.ring-2]="selectedChart()?.chartId === chart.chartId"
							[class.ring-primary]="selectedChart()?.chartId === chart.chartId"
							(click)="selectChart(chart)">
							<div class="aspect-square bg-base-300 flex items-center justify-center overflow-hidden">
								@if (chart.hasAlbumArt && getAlbumArtUrl(chart)) {
									<img [src]="getAlbumArtUrl(chart)" class="w-full h-full object-cover" alt="Album art" />
								}
								@if (chart.hasAlbumArt && !getAlbumArtUrl(chart)) {
									<span class="loading loading-spinner loading-sm"></span>
								}
								@if (!chart.hasAlbumArt) {
									<i class="bi bi-image text-3xl text-base-content/20"></i>
								}
							</div>
							<div class="p-2">
								<div class="text-xs font-medium truncate">{{ chart.chartName }}</div>
								<div class="text-xs text-base-content/60 truncate">{{ chart.chartArtist }}</div>
							</div>
						</div>
					}
				</div>
				@if (filteredBrowseCharts().length === 0 && !loadingCharts()) {
					<div class="text-center text-base-content/50 py-8">No charts match your filter</div>
				}
				@if (loadingCharts()) {
					<div class="text-center py-8">
						<span class="loading loading-spinner loading-lg"></span>
						<div class="text-sm text-base-content/60 mt-2">Loading charts...</div>
					</div>
				}
			</div>
		</div>
	}

	<!-- Browse All Backgrounds Mode -->
	@if (viewMode() === 'browseBackgrounds') {
		<div class="flex-1 min-h-0 flex flex-col">
			<!-- Header -->
			<div class="flex items-center gap-4 mb-4">
				<button class="btn btn-sm btn-ghost" (click)="setViewMode('overview')"><i class="bi bi-arrow-left"></i> Back</button>
				<h3 class="font-semibold flex-1">Browse All Backgrounds - {{ filteredBrowseBackgroundCharts().length }} charts</h3>
			</div>
			<!-- Filter Bar -->
			<div class="flex gap-2 mb-3 items-center flex-wrap">
				<div class="join">
					<input
						type="text"
						placeholder="Search artist or song..."
						class="input input-sm input-bordered join-item w-48"
						[ngModel]="filterQuery()"
						(ngModelChange)="onFilterQueryChange($event); applyBrowseBackgroundsFilter()" />
					@if (filterQuery()) {
						<button class="btn btn-sm btn-ghost join-item" (click)="onFilterQueryChange(''); applyBrowseBackgroundsFilter()">
							<i class="bi bi-x"></i>
						</button>
					}
				</div>
				<select class="select select-sm select-bordered w-40" [ngModel]="filterArtist()" (ngModelChange)="onFilterArtistChange($event); applyBrowseBackgroundsFilter()">
					<option value="">All Artists</option>
					@for (artist of browseBackgroundArtistOptions(); track artist) {
						<option [value]="artist">{{ artist }}</option>
					}
				</select>
				<label class="cursor-pointer flex items-center gap-2">
					<input
						type="checkbox"
						class="checkbox checkbox-sm"
						[ngModel]="browseBackgroundsShowMissingOnly()"
						(ngModelChange)="onBrowseBackgroundsShowMissingOnlyChange($event)" />
					<span class="text-sm">Show missing only</span>
				</label>
				<!-- Blur control -->
				<div class="flex items-center gap-2 ml-auto pl-4 border-l border-base-300">
					<span class="text-sm">Blur:</span>
					<input type="range" min="0" max="50" [ngModel]="blurAmount()" (ngModelChange)="onBlurAmountChange($event)" class="range range-xs range-primary w-24" />
					<span class="text-sm font-mono w-6">{{ blurAmount() }}</span>
				</div>
			</div>
			<!-- Batch controls -->
			<div class="flex items-center gap-3 mb-3 p-3 bg-base-200 rounded-lg">
				<button class="btn btn-sm btn-ghost" (click)="selectAllBrowseBackgrounds()">
					{{ selectedBrowseBackgroundIds().size === filteredBrowseBackgroundCharts().length ? 'Deselect All' : 'Select All' }}
				</button>
				<span class="text-sm text-base-content/60">{{ selectedBrowseBackgroundIds().size }} selected</span>
				<div class="flex-1"></div>
				<button
					class="btn btn-sm btn-primary"
					(click)="regenerateSelectedBackgrounds()"
					[disabled]="selectedBrowseBackgroundIds().size === 0 || isProcessing()">
					<i class="bi bi-arrow-repeat" [class.animate-spin]="isProcessing()"></i>
					Regenerate Selected
				</button>
			</div>
			<!-- Batch results -->
			@if (batchResults()) {
				<div class="alert mb-3" [class.alert-success]="batchResults()!.failed === 0" [class.alert-warning]="batchResults()!.failed > 0">
					<i class="bi bi-info-circle"></i>
					<span> Completed: {{ batchResults()!.success }} success, {{ batchResults()!.failed }} failed, {{ batchResults()!.skipped }} skipped </span>
					<button class="btn btn-sm btn-ghost" (click)="clearBatchResults()">
						<i class="bi bi-x"></i>
					</button>
				</div>
			}
			<!-- Selected chart panel -->
			@if (selectedChart()) {
				<div class="mb-4 p-4 bg-base-200 rounded-lg">
					<div class="flex gap-4">
						<div class="w-48 h-28 bg-base-300 rounded flex items-center justify-center overflow-hidden">
							@if (selectedChart()!.hasBackground && getBackgroundUrl(selectedChart()!)) {
								<img [src]="getBackgroundUrl(selectedChart()!)" class="w-full h-full object-cover" alt="Current background" />
							}
							@if (selectedChart()!.hasBackground && !getBackgroundUrl(selectedChart()!)) {
								<span class="loading loading-spinner"></span>
							}
							@if (!selectedChart()!.hasBackground) {
								<i class="bi bi-file-image text-4xl text-base-content/30"></i>
							}
						</div>
						<div class="flex-1">
							<h4 class="font-semibold">{{ selectedChart()!.chartName }}</h4>
							<p class="text-sm text-base-content/60">{{ selectedChart()!.chartArtist }}</p>
							<p class="text-xs text-base-content/40 mt-1">
								@if (selectedChart()!.hasAlbumArt) {
									<span class="text-success">Has album art</span>
								}
								@if (!selectedChart()!.hasAlbumArt) {
									<span class="text-warning">No album art (will use gradient)</span>
								}
							</p>
							<div class="mt-2 flex gap-2 flex-wrap items-center">
								<button class="btn btn-sm btn-primary" (click)="regenerateSingleBackground()" [disabled]="isProcessing()">
									<i class="bi bi-arrow-repeat" [class.animate-spin]="isProcessing()"></i>
									{{ selectedChart()!.hasBackground ? 'Regenerate' : 'Generate' }} Background
								</button>
								<button class="btn btn-sm btn-ghost" (click)="selectedChart.set(null)">Cancel</button>
								<div class="flex items-center gap-2 ml-4">
									<span class="text-xs">Blur:</span>
									<input type="range" min="0" max="50" [ngModel]="blurAmount()" (ngModelChange)="onBlurAmountChange($event)" class="range range-xs range-primary w-20" />
									<span class="text-xs font-mono">{{ blurAmount() }}</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			}
			<!-- Thumbnail Grid -->
			<div class="flex-1 overflow-y-auto scrollbar scrollbar-w-2 scrollbar-track-base-300 scrollbar-thumb-neutral scrollbar-thumb-rounded-full">
				<div class="grid gap-3" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr))">
					@for (chart of filteredBrowseBackgroundCharts(); track chart) {
						<div
							class="cursor-pointer rounded-lg overflow-hidden bg-base-200 hover:bg-base-300 transition-colors relative"
							[class.ring-2]="selectedChart()?.chartId === chart.chartId"
							[class.ring-primary]="selectedChart()?.chartId === chart.chartId"
							(click)="selectChart(chart)">
							<!-- Selection checkbox -->
							<div class="absolute top-2 left-2 z-10" (click)="$event.stopPropagation()">
								<input
									type="checkbox"
									class="checkbox checkbox-sm checkbox-primary"
									[checked]="selectedBrowseBackgroundIds().has(chart.chartId)"
									(change)="toggleBrowseBackgroundSelection(chart.chartId)" />
							</div>
							<div class="aspect-video bg-base-300 flex items-center justify-center overflow-hidden">
								@if (chart.hasBackground && getBackgroundUrl(chart)) {
									<img [src]="getBackgroundUrl(chart)" class="w-full h-full object-cover" alt="Background" />
								}
								@if (chart.hasBackground && !getBackgroundUrl(chart)) {
									<span class="loading loading-spinner loading-sm"></span>
								}
								@if (!chart.hasBackground) {
									<i class="bi bi-file-image text-3xl text-base-content/20"></i>
								}
							</div>
							<div class="p-2">
								<div class="text-xs font-medium truncate">{{ chart.chartName }}</div>
								<div class="text-xs text-base-content/60 truncate">{{ chart.chartArtist }}</div>
							</div>
						</div>
					}
				</div>
				@if (filteredBrowseBackgroundCharts().length === 0 && !loadingCharts()) {
					<div class="text-center text-base-content/50 py-8">No charts match your filter</div>
				}
				@if (loadingCharts()) {
					<div class="text-center py-8">
						<span class="loading loading-spinner loading-lg"></span>
						<div class="text-sm text-base-content/60 mt-2">Loading charts...</div>
					</div>
				}
			</div>
		</div>
	}
</div>
